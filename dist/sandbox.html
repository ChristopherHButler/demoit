<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Demoit</title>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <style>
      html {
        box-sizing: border-box;
        width: 100%;
        height: 100%;
      }
      *, *:before, *:after {
        box-sizing: inherit;
      }
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: "Fira Mono", monospace;
        font-size: 14px;
        line-height: 1.2em;
        background: #fff;
        color: #000;
        box-sizing: inherit;
      }
      .output {
        height: 100%;
        font-size: 100%;
        vertical-align: baseline;
      }
      .centered {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      @keyframes bubble {
        0%   { transform: scale(0.5); }
        50%  { transform: scale(1.2); }
        100% { transform: scale(0.5); }
      }
      .spinner {
        width: 20px;
        height: 20px;
        background: #999;
        border-radius: 10px;
        animation: bubble 1.0s infinite;
        -webkit-animation: bubble 1.0s infinite;
      }
    </style>
  </head>
<body>
  <div id="output" class="output"></div>
  <script>

    var HINT = '<div class="centered">&lt;div id="output" /&gt;</div>';
    var SPINNER = '<div class="centered"><div class="spinner"></div></div>';
    var container = document.querySelector('#output');
    var operationSuccessful = function (marker) {
      window.top.postMessage({ marker: marker });
    }
    var logMessage = function (message) {
      window.top.postMessage({ log: message });
    }

    container.innerHTML = SPINNER;

    window.onmessage = function(e) {
      if (e.data && e.data.op) {
        //console.log('--> ' + e.data.marker + ' ' + e.data.op);
        switch(e.data.op) {
          case 'html':
            container.innerHTML = e.data.value;
            operationSuccessful(e.data.marker);
          break;
          case 'reload':
            window.location.reload();
          break;
          case 'dependencies':
            loadDeps(e.data.value).then(function() {
              operationSuccessful(e.data.marker);
            });
          break;
          case 'code':
            while (container.firstChild) {
              container.removeChild(container.firstChild);
            }
            container.innerHTML = '';
            (new Function('index', e.data.value.code))(e.data.value.entryPoint);
            operationSuccessful(e.data.marker);
          break;
        }
      }
    };

    // DEPENDENCIES -------------------------------------------------------------

    var addJSFile = function (path, done) {
      const node = document.createElement('script');

      node.src = path;
      node.addEventListener('load', function () {
        done();
      });
      setTimeout(function () {
        document.body.appendChild(node);
      }, 1);
      return true;
    };
    const addCSSFile = function (path, done) {
      const node = document.createElement('link');

      node.setAttribute('rel', 'stylesheet');
      node.setAttribute('type', 'text/css');
      node.setAttribute('href', path);
      node.addEventListener('load', function () {
        done();
      });
      setTimeout(function () {
        document.body.appendChild(node);
      }, 1);
      return true;
    };

    function loadDeps(dependencies) {
      return new Promise(done => {
        (function load(index) {
          if (index === dependencies.length) {
            done();
            return;
          }

          const resource = dependencies[index];
          const extension = resource.split('.').pop().toLowerCase();

          if (extension === 'js') {
            addJSFile(resource, () => load(index + 1));
          } else if (extension === 'css') {
            addCSSFile(resource, () => load(index + 1));
          } else {
            load(index + 1);
          }
        })(0);
      });
    };

    // execute css and html -------------------------------------------------------------

    const guaranteeValidIdName = filename => filename.replace(/\./g, '_');

    function executeCSS (filename, content) {
      const node = document.createElement('style');
  
      node.setAttribute('id', guaranteeValidIdName(filename));
      node.innerHTML = content;
      setTimeout(function () {
        document.body.appendChild(node);
      }, 1);
    };

    function executeHTML (filename, content) {
      const node = document.createElement('div');
    
      node.innerHTML = content || ' ';
      container.appendChild(node.firstChild);
    };

    // console  -------------------------------------------------------------

    function htmlEncode(str) {
      return str.replace(/[&<>"']/g, function ($0) {
          return "&" + {"&": "amp", "<": "lt", ">": "gt", '"': "quot", "'": "#39"}[$0] + ";";
      });
    }
    
    function addLog(something) {
      logMessage(something ? htmlEncode(something.toString()) : something);
    };
  
    (function () {
      const originalError = console.error;
      const originalLog = console.log;
      const originalWarning = console.warn;
      const originalInfo = console.info;
      const originalClear = console.clear;
  
      console.error = function (error) {
        addLog(error.stack);
        originalError.apply(console, arguments);
      };
      console.log = function (...args) {
        args.forEach(addLog);
        originalLog.apply(console, args);
      };
      console.warn = function (...args) {
        args.forEach(addLog);
        originalWarning.apply(console, args);
      };
      console.info = function (...args) {
        args.forEach(addLog);
        originalInfo.apply(console, args);
      };
    })();

    // init -------------------------------------------------------------

    operationSuccessful('loaded');

  </script>
</body>
</html>